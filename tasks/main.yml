- name: install OpenSSH server
  apt:
    name:
      - openssh-server
      # For Ansible become
      - acl
    state: present
    update_cache: False
    install_recommends: False

- name: configure /etc/ssh/sshd_config.d/ansible.conf
  template:
    src: etc/ssh/sshd_config.d/ansible.conf.j2
    dest: /etc/ssh/sshd_config.d/ansible.conf
    owner: root
    group: root
    mode: 0644
  notify: restart sshd
  when: ssh_sshd_config is defined
  tags:
    - config

- name: configure /etc/ssh/ssh_config.d/ansible.conf
  template:
    src: etc/ssh/ssh_config.d/ansible.conf.j2
    dest: /etc/ssh/ssh_config.d/ansible.conf
    owner: root
    group: root
    mode: 0644
  when: ssh_ssh_config is defined
  notify: restart sshd
  tags:
    - config

- name: "include tasks to manage user {{ ssh_user['name'] }}"
  include_tasks: users/manage.yml
  with_items: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
  when: ssh_user['state'] | default('present') != 'absent'

- name: "include tasks to remove user {{ ssh_user['name'] }}"
  include_tasks: users/remove.yml
  with_items: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
  when: ssh_user['state'] | default('present') == 'absent'
